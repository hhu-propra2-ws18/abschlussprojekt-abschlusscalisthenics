# Dokumentation - Team Abschlusscalisthenics


## Tag 1

. Eine grobe Architektur für die Anwendung wurde erstellt.
Offene Fragen: Interaktion von unangemeldeten Usern und Website.

## Tag 2
. Frontend Entwicklung hat angefangen.
. Die Datenbank wurde aufgesetzt. Noch Probleme mit den Models.
. Docker wurde angefangen: Der Dockerfile und eine .yml-Datei um die Datenbank einzeln starten zu können.

## Tag 3
. Die Datenbank wurde fertig gestellt. Die Entitäten, welche in der Datenbank gespeichert werden,
sind die User, Artikel, Ausleihen, Bilder und Adressen.
.. User: Besitzen einen eindeutigen Benutzernamen, eine Email, ein verschlüsseltes Passwort
und eine Adresse
.. Item: Besitzt eine automatisch generierte eindeutige Id, einen Namen, Beschreibung,
Kosten, Kaution, Standort, aktuelle Verfügbarkeit und gesamte Einstellungsdauer.
Außerdem wird der der Primärschlüssel von User als Fremdschlüssel gespeichert.
.. Address: Besitzt eine Straße, Hausnummer, Stadt und PLZ
.. Loan: Speichert die gesamte Ausleihdauer und den Status der Ausleihe (z.B. Laufend,
  Abgeschlossen, Konflikt, ...). Zusätzlich werden die ItemId und der username des Users, der
  sich den Artikel ausleiht gespeichert. Über die itemId kann dann auch der User, welcher
  den Artikel verleiht ermittelt werden.
.. Picture: Besitzt ebenfalls eine automatisch generierte und eindeutige Id und ein Blob.
Der Verweis auf den zugehörigen Artikel erfolgt durch Speichern des Fremdschlüssels item_id.

. Für User, Item, Loan und Picture wurden je ein Repository erstellt. Address wurde als Embedabble
implementiert. Die Repositories wurden außerdem um eine Query erweitert, über die man die Entitäten
nach den Fremdschlüsseln filtern kann.

## Tag 4
. Travis fertig gestellt
. Arbeit an Docker
.. Probleme mit der Datenbank
.. Probleme eine Datenbank für development Zwecke in der selben .properties Datei zu starten
. Frontend:
.. arbeit an Seiten
.. Thymeleaf angefangen einzubeziehen


## Tag 5
. Docker wurde fertiggestellt:
.. docker-compose up:
... stellt Anwendung auf localhost:8080 bereit
... stellt die Datenbank nach außen abgeschlossen auf leihordiedb:3306 bereit
... stellt Propay auf localhost:8888 bereit
.. docker-compose -f datenbanktest.yml up:
... stellt eine Testdatenbank nach außen offen auf localhost:3306 bereit
. Anpassung der Datenbank
. arbeit an Test für Uploadcontroller
. ItemRepository Test fertiggestellt
.. 3 Helfer Klassen:
... DummyItemGenerator
... SummyUserGenerator
... DummyLoanGenerator.
.arbeit an LoanRepository Test
. 2 Controller geschrieben: UserController, HomepageController
. arbeit an html Seiten

## Tag 6
. Formvalidation für das Login und Signup wurde fertiggestellt
. Arbeit an der Formvalidation vom ItemController
. Arbeit am ErrorController wurde begonnen
. Man hat sich darauf geeinigt für das Login Spring Security zu verwenden
. docker-compose ist fertig, man hat sich für die Entwicklung entschieden eine "Testdatenbank" zu benutzen,
da das Aufsetzen Zeit kostet und für das Testen den Workflow behindert

## Tag 7 + 8 + 9 + 10
. Die Idee, die Authentifizierung mit Spring Security zu implementieren, wurde verworfen, weil ...
. der Fotoupload wurde überarbeitet und funktioniert
.. Der Wunsch war eine Art slideshow zu implementieren, die aus irgendeinem Grund nicht funktioniert
auf der item-detail Seite
. Passwörter wurden implementiert, da eine Service ohne Passwörter unnatürlich ist
. Die Templates wurden im Laufe der Tage angepasst oder umgeändert. Das Layout passt sich unter anderem der Geschäftslogik
an, ohne dabei seine Essenz zu verlieren.





## Authentifizierung
Wir haben uns bei der Authentifizierung gegen die Verwendung von Spring Security
entschieden, da es beim Login Probleme bei der Umsetzung der vorher definierten
User Datenbank gab. +
Stattdessen haben wir die Authentifizierung mit einem Interceptor und einer
Session-Datenbank umgesetzt. Beim Einloggen wird ein Session-Cookie gesetzt,
der in der Session-Datenbank gemeinsam mit dem User abgespeichert wird, wodurch
jeder einzelne Nutzer eindeutig identifiziert werden kann. Der Interceptor fängt
alle Anfragen auf zugriffsbeschränkte Seiten ab und prüft, ob der in der Anfrage
enthaltene Cookie in der Datenbank existiert. Ist dies der Fall wird der Nutzer
identifiziert und auf die angefragte Seite geleitet. Kann der Nutzer nicht identifiziert
werden, wird er auf die Login-Page weitergeleitet. +
Durch Ausnahmen ist es erlaubt die Start-, Login- und Registrierungsseite, sowie
alle Artikelseiten ohne Anmeldung zu erreichen. Meldet sich ein Nutzer ab,
wird die Session aus der Datenbank gelöscht.

## Einstellen von Artikeln
Um einen Artikel einzustellen, werden in einem Formular allgemeine Informationen
über den Artikel eingegeben. Durch eine Checkbox auf der Formularseite ist es dem
Nutzer auch möglich Artikel zum Verkauf anzubieten. +
Anschließend gibt es die Möglichkeit bis zu 10 Bilder des Artikels hochzuladen.
Aus Zeitgründen haben wir nur den zeitgleichen Upload eines einzigen Bildes
implementiert. Möchte man mehrere Bilder hochladen, muss man nacheinander auf Upload
klicken. +
Nach dem Hochladen der Fotos ist der Einstellprozess beendet und der Artikel ist in
der Artikelliste auf der Homepage zu finden.

## Benutzerkonto
Auf der Benutzerseite wird dem Nutzer eine Übersicht der Artikel, die
er eingestellt und selbst ausgeliehen hat, angezeigt. Es werden alle Anfragen
zum Verleihen aufgelistet und man hat die Möglichkeit diese anzunehmen oder abzulehnen.
Nimmt man eine Anfrage an, muss der Anbieter noch bestätigen, dass der Artikel abgeholt wurde
und am Ende muss man auch wieder angeben, wann der Artikel zurückgegeben wurde. +
Über das Menü hat der Nutzer Zugriff auf sein ProPay-Konto, wo er seinen Kontostand
erhöhen kann und alle Transaktionen an denen er beteiligt ist einsehen kann.

## Ausleihprozess
Um einen Artikel auszuleihen, muss ein eingeloggter User eine Anfrage an den
Anbieter senden und dabei die gewünschte Ausleihdauer angeben. Ein Artikel
ist immer für die angegebene max. Ausleihdauer verfügbar, wenn er online ist und
gerade nicht ausgeliehen wird. Möchte man einen Artikel nicht mehr anderen Nutzern
zur Verfügung stellen, muss man ihn löschen, da Artikel nicht automatisch von der
Seite genommen werden. +
Die Kaution des Artikels wird bereits nach Abschicken der Anfrage auf dem ProPay
Konto reserviert, um zu verhindern, dass beim Annehmen einer Anfrage das Geld für die
Reservierung nicht mehr verfügbar ist. +
Im nächsten Schritt entscheidet der Anbieter, ob er die Anfrage annehmen möchte oder nicht.
Wird die Anfrage angenommen ändert sich der Zustand der Ausleihe auf "accepted" und
der nächste Schritt erfordert die Abholung des Artikels am angegebenen Artikelstandort.
Wurde der Artikel abgeholt, muss der Anbieter dies in seinem Benutzerkonto bestätigen und
der Status der Ausleihe ändert sich zu "active". Ab diesem Zeitpunkt werden
die Tage der Ausleihe gezählt und der Anbieter muss am Ende bestätigen, dass er den
Artikel zurückerhalten hat. Erst wenn der Anbieter dies bestätigt, wird das Geld zwischen
den Konten transferiert. Besitzt die Person, die sich den Artikel ausgeliehen hat, nicht genug
Geld auf ihrem Konto wird eine Fehlermeldung dargestellt und der Anbieter kann einen
Konflikt eröffnen. +
Wird eine Leihfrist überschritten, wird beiden Parteien der Ausleihe beim Einloggen
eine Pop-Up Meldung angezeigt, in der die Artikel und die Überschreitungsdauer
dargestellt sind.


## Benötigte Änderungen für den Kaufprozess
Unsere Architektur hat es uns erlaubt, mit wenigen Ergänzungen und
Änderungen die Verkaufsoption in unser System zu integrieren. +
Dateien die hinzugefügt werden mussten: +

* BuyRepository.java
* BuyForm.java
* Buy.java
* BuyController.java

Das BuyRepository und das Buy-Model sind nötig, da genau wie mit dem
LoanRepository ein abgeschlossener Kauf gespeichert wird. Das erlaubt es auch
später noch käufe zurückverfolgen zu können. Das Buy-Model erlaubt es alle Daten
zu erfassen, die für einen Kaufvorgang wichtig sind. +
Der BuyController wurde benötigt um die Logik hinter den neuen Buttons, also das
Verkaufen, zu realisieren. Das BuyForm ist eine Hilfsklasse, die es ermöglicht,
weitere Daten an den Controller zu übergeben. +

Dateien die Verändert werden mussten: +

* Item.java
* user-shop.html
* item-detail.html

Item.java musste dahingehend angepasst werden, dass es noch möglich ist, einen
Verkaufspreis zu speichern.

Im Frontend mussten ebenfalls nicht viele Änderungen vorgenommen werden. Es
mussten lediglich ein Button zum kaufen eingefügt werden und die Möglichkeit für
einen Anbieter den Verkauf zu bestätigen oder abzulehnen. Dazu wurde eine
Abschnitt in der Ansicht von dem eigenen Benutzerkonto eingefügt, in der man die
Käufe die man getätigt hat sieht sowie die verkauften Artikel. Außerdem musste
das Formular mit dem ein neuer Artikel eingefügt wird angepasst werden, sodass
man einen Verkaufspreis festlegen kann.

## Konfliktlösung
